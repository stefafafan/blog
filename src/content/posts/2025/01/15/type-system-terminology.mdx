---
title: 'TBD: 型システムに関する用語の整理'
description: 'RustやTypeScriptのコードを用いながら整理します。'
date: 2025-01-15
tags: ['rust', 'typescript', 'type-safety']
draft: false
---

こんにちは、 id:stefafafan です。最近私は仕事でTypeScriptを書いたり、趣味でRustの勉強をしています。その中で、様々な型システムに関する用語を目にしてきました。自分の中でそれらの用語の違いを整理するためにも、この記事を書いてみようと思います。

## この記事のゴール
- 型に関する用語の関係性について私自身混乱しているため、記事としてまとめることで考えを整理すること
- 私と同じように理解が曖昧な方に向けて整理の手助けをすること

## Structural Typing (構造的型付け) と Nominal Typing (名前的型付け)

プログラミング言語の型システムには Structural Typing (構造的型付け) と Nominal Typing (名前的型付け)の2つの型付けの方法があります。まずはこの2つの違いについて整理を試みます。

{/*
TODO:
- TAPL本を参照する
- それぞれの特徴・良し悪し
*/}

### Structural Typing (構造的型付け)

構造的型付けにおいては、型の互換性は値の構造によって決まります。構造的型付けを採用する言語として代表的なものにはTypeScriptがあります。

例えば TypeScript のドキュメントにも掲載されている以下の例 [^1] を見てみましょう。

[^1]: https://www.typescriptlang.org/docs/handbook/type-compatibility.html

```typescript
interface Pet {
  name: string;
}
class Dog {
  name: string;
}
let pet: Pet;
// OK, because of structural typing
pet = new Dog();
```

この例では `Pet` という `interface` と `Dog` という `class` があります。`Dog` は `Pet` という `interface` に `name` というプロパティがあるという点で互換性があるため、`pet = new Dog();` という代入が可能です。

このように、構造的型付けでは型の互換性は値の構造によって決まります。

### Nominal Typing (名前的型付け)

名前的型付けでは型の互換性は型の名前によって決まります。名前的型付けを採用する言語としての一例にはRustがあります。

先ほどの TypeScript の例をRustで書いた場合、以下のようになります。

```rust
struct Pet {
    name: String,
}

struct Dog {
    name: String,
}

fn main() {
    let pet: Pet;
    pet = Dog {
        // ^^^ mismatched types expected `Pet`, found `Dog`
        name: String::from("Hachi"),
    };
}
```

`Pet` として定義された変数に `Dog` を代入しようとすると、Rust は型エラーを出力します。Rust では型の名前によって互換性が決まるため、 `Pet` と `Dog` は別の型として扱われます。

しかし、以下の例のようにプリミティブ型をそのまま利用する際は Rust のコンパイラは型エラーを出力しません。このようなケースにおいては後述する New Type Pattern などを利用して型安全性を確保することが推奨されています。

```rust
// マイル数をキロメートル数に変換する関数
fn miles_to_kilometers(miles: f64) -> f64 {
    miles * 1.60934
}

fn main() {
    let m = 10.0;
    let k = miles_to_kilometers(m);
    println!("{} miles is equal to {} kilometers", m, k);

    let k2: f64 = 20.0;
    // !! miles 引数に対して kilometers の値を渡しても型エラーにならない!!
    let m2: f64 = miles_to_kilometers(k2);
    println!("{} miles is equal to {} kilometers", m2, k2);
}
```

## Polymorphism (多態性・多相性)

型システムにおいて、Polymorphismについても話していく必要があります。

> Polymorphism (多態性)とは複数のデータ型を 1 つのインターフェイスにまとめた表現です。
> https://developer.mozilla.org/ja/docs/Glossary/Polymorphism

大きく3つの種類があります。 [^2]

[^2]: https://en.wikipedia.org/wiki/Polymorphism_(computer_science)

- Ad-hoc Polymorphism (特殊化多相性)
- Parametric Polymorphism (パラメトリック多相性)
- Subtyping (部分型・派生型など)

ここでは、Subtyping (部分型・派生型など) について詳しく見ていきます。

### Subtyping (部分型・派生型など) 

### Structural Subtyping (構造的部分型)

### Nominal Subtyping (公称的部分型)

## Variance（変性）とは
- Covariant (共変)
- Contravariant (反変)
- Invariant (不変)

## Type Safety (型安全性) とは
- TAPL本を参照する

## New Type Pattern
- Haskell での例
- Rust での例
- TypeScript での例
  - Branded Types
  - zod, newtype-ts, type-fest, ...

## Phantom Types (幽霊型)
- Rust での例
- TypeScript での例

## Opaque Types
- Rust での例
- TypeScript での例

## まとめ
- 概念の整理
  - Structural Typing, Nominal Typing
  - Subtyping, Variance
  - New Type Pattern, Phantom Types, Opaque Types

## 参考

https://wiki.haskell.org/index.php?title=Newtype

https://www.haskell.org/onlinereport/decls.html#sect4.2.3

https://haskell.jp/blog/posts/2020/how-to-use-type-newtype-data.html

https://scrapbox.io/mrsekut-p/Haskell%E3%81%AEnewtype

https://speakerdeck.com/konn/ben-dang-hasugoi-newtype

https://medium.com/@KevinBGreene/surviving-the-typescript-ecosystem-branding-and-type-tagging-6cf6e516523d

https://michalzalecki.com/nominal-typing-in-typescript/#approach-4-intersection-types-and-brands

TAPL本

https://wiki.c2.com/?NominativeAndStructuralTyping

https://bufferings.hatenablog.com/entry/2025/01/12/171721

https://www.learningtypescript.com/articles/branded-types

https://effect.website/docs/code-style/branded-types/

https://scrapbox.io/nyaagoo/Structural_Subtyping_vs_Nominal_Subtyping_%E6%AF%94%E8%BC%83%E3%81%97%E3%81%A6%E7%90%86%E8%A7%A3%E3%81%99%E3%82%8B

https://lexi-lambda.github.io/blog/2020/11/01/names-are-not-type-safety/

https://lexi-lambda.github.io/blog/2020/08/13/types-as-axioms-or-playing-god-with-static-types/

https://www.typescriptlang.org/docs/handbook/type-compatibility.html

https://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%96%E3%82%BF%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0_(%E8%A8%88%E7%AE%97%E6%A9%9F%E7%A7%91%E5%AD%A6)

https://en.wikipedia.org/wiki/Polymorphism_(computer_science)

https://developer.mozilla.org/ja/docs/Glossary/Polymorphism
